<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统计分析 - 全球疏浚情报</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans SC"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            border: '#334155',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .glass-card:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .chart-container-lg {
            position: relative;
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body class="min-h-screen font-sans antialiased selection:bg-brand-500 selection:text-white pb-10">

    <!-- Navbar -->
    <nav class="sticky top-0 z-40 w-full glass-card border-b border-white/5 mb-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-brand-500 to-brand-600 flex items-center justify-center shadow-lg shadow-brand-500/20">
                        <i class="fa-solid fa-earth-americas text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400 hidden md:block">
                            全球疏浚情报
                        </h1>
                        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400 md:hidden">
                            全球疏浚情报
                        </h1>
                        <p class="text-xs text-gray-400 hidden md:block">统计分析</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <a href="/" class="flex items-center justify-center gap-2 px-3 h-10 rounded-lg bg-white/5 border border-white/10 text-gray-200 hover:bg-white/10 transition-all text-sm font-medium whitespace-nowrap">
                        <i class="fa-solid fa-arrow-left text-sm"></i>
                        <span>返回首页</span>
                    </a>
                    <a href="/vessel_map.html" target="_blank" class="flex items-center justify-center gap-2 px-3 h-10 rounded-lg bg-cyan-500/10 border border-cyan-500/20 text-cyan-400 hover:bg-cyan-500/20 transition-all text-sm font-medium whitespace-nowrap" title="全球船舶跟踪">
                        <i class="fa-solid fa-ship text-lg md:text-sm"></i> 
                        <span class="hidden md:inline">全球船舶跟踪</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>
    
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-6">
        
        <!-- Filter Bar -->
        <div class="glass-card rounded-2xl p-5">
            <div class="flex flex-wrap items-end gap-3">
                <div class="flex flex-col">
                    <label class="text-xs text-gray-400 mb-1">时间范围</label>
                    <div id="date-range" class="flex items-center bg-dark-card border border-dark-border rounded-lg overflow-hidden h-[42px] cursor-pointer">
                        <input id="filter-start-date" type="date" class="bg-transparent border-none text-white text-sm focus:ring-0 w-32 px-2 h-full">
                        <span class="text-gray-500 px-1">-</span>
                        <input id="filter-end-date" type="date" class="bg-transparent border-none text-white text-sm focus:ring-0 w-32 px-2 h-full">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadStats()" class="h-[42px] px-5 bg-brand-600 hover:bg-brand-500 text-white rounded-lg transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-filter"></i> 筛选
                    </button>
                    <button onclick="resetFilter()" class="h-[42px] px-5 bg-white/5 hover:bg-white/10 text-gray-300 rounded-lg transition-colors">
                        重置
                    </button>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Pie Chart: Categories -->
            <div class="glass-card rounded-2xl p-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-chart-pie text-brand-400"></i> 六大类情报占比
                </h3>
                <div class="chart-container">
                    <canvas id="categoryPieChart"></canvas>
                </div>
            </div>

            <!-- Line Chart: Trend -->
            <div class="glass-card rounded-2xl p-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-chart-line text-green-400"></i> 情报数量趋势
                </h3>
                <div class="chart-container">
                    <canvas id="trendLineChart"></canvas>
                </div>
            </div>

            <!-- Bar Chart: Sources Ladder -->
            <div class="lg:col-span-2 glass-card rounded-2xl p-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-ranking-star text-yellow-400"></i> 数据源有效新闻天梯图
                </h3>
                <div class="chart-container-lg">
                    <canvas id="sourceBarChart"></canvas>
                </div>
            </div>

        </div>

    </main>

    <script>
        let categoryPieChart = null;
        let trendLineChart = null;
        let sourceBarChart = null;

        // Colors for charts
        const chartColors = [
            '#0ea5e9', '#22c55e', '#eab308', '#f97316', '#ec4899', '#8b5cf6', 
            '#6366f1', '#14b8a6', '#f43f5e', '#a855f7'
        ];

        document.addEventListener('DOMContentLoaded', () => {
            // Set default dates (last 30 days)
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - 30);
            
            document.getElementById('filter-end-date').valueAsDate = end;
            document.getElementById('filter-start-date').valueAsDate = start;
            bindDateRangePicker('date-range', 'filter-start-date', 'filter-end-date');
            
            loadStats();
        });

        function resetFilter() {
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - 30);
            document.getElementById('filter-end-date').valueAsDate = end;
            document.getElementById('filter-start-date').valueAsDate = start;
            loadStats();
        }

        async function loadStats() {
            const start = document.getElementById('filter-start-date').value;
            const end = document.getElementById('filter-end-date').value;
            
            try {
                const response = await fetch(`/api/statistics?start=${start}&end=${end}`);
                const data = await response.json();
                
                renderPieChart(data.category_stats);
                renderLineChart(data.trend_stats);
                renderBarChart(data.source_stats);
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        function bindDateRangePicker(rangeId, startId, endId) {
            const range = document.getElementById(rangeId);
            const startInput = document.getElementById(startId);
            const endInput = document.getElementById(endId);
            if (!range || !startInput || !endInput) return;
            const openPicker = (input) => {
                input.focus();
                if (typeof input.showPicker === 'function') {
                    input.showPicker();
                }
            };
            range.addEventListener('click', (event) => {
                if (event.target === startInput || event.target === endInput) return;
                const rect = range.getBoundingClientRect();
                const isLeft = (event.clientX - rect.left) < rect.width / 2;
                openPicker(isLeft ? startInput : endInput);
            });
        }

        function renderPieChart(data) {
            const ctx = document.getElementById('categoryPieChart').getContext('2d');
            
            if (categoryPieChart) categoryPieChart.destroy();
            
            categoryPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: chartColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#cbd5e1' }
                        }
                    }
                }
            });
        }

        function renderLineChart(data) {
            const ctx = document.getElementById('trendLineChart').getContext('2d');
            
            if (trendLineChart) trendLineChart.destroy();
            
            const categories = Array.isArray(data.categories) ? data.categories : [];
            const dates = Array.isArray(data.dates) ? data.dates : [];
            let datasets = [];
            
            if (Array.isArray(data.datasets) && data.datasets.length > 0) {
                datasets = data.datasets.map((dataset, index) => ({
                    label: dataset.label || categories[index] || `系列${index + 1}`,
                    data: Array.isArray(dataset.data) ? dataset.data : dates.map(() => 0),
                    borderColor: chartColors[index % chartColors.length],
                    tension: 0.4,
                    fill: false
                }));
            } else if (data.values) {
                datasets = categories.map((cat, index) => ({
                    label: cat,
                    data: dates.map(date => (data.values[cat] && data.values[cat][date]) ? data.values[cat][date] : 0),
                    borderColor: chartColors[index % chartColors.length],
                    tension: 0.4,
                    fill: false
                }));
            } else {
                datasets = categories.map((cat, index) => ({
                    label: cat,
                    data: dates.map(() => 0),
                    borderColor: chartColors[index % chartColors.length],
                    tension: 0.4,
                    fill: false
                }));
            }

            trendLineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#cbd5e1' }
                        }
                    }
                }
            });
        }

        function renderBarChart(data) {
            const ctx = document.getElementById('sourceBarChart').getContext('2d');
            
            if (sourceBarChart) sourceBarChart.destroy();
            
            sourceBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: '有效新闻数量',
                        data: data.values,
                        backgroundColor: '#0ea5e9',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    </script>
</body>
</html>
