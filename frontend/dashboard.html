<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全球疏浚情报智能大屏</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Inter & Noto Sans SC -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans SC"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9', // Sky 500
                            600: '#0284c7',
                            800: '#075985',
                            900: '#0c4a6e', // Sky 900
                        },
                        dark: {
                            bg: '#0f172a', // Slate 900
                            card: '#1e293b', // Slate 800
                            border: '#334155', // Slate 700
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .glass-card:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body class="min-h-screen font-sans antialiased selection:bg-brand-500 selection:text-white pb-10">

    <!-- Navbar -->
    <nav class="sticky top-0 z-40 w-full glass-card border-b border-white/5 mb-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-brand-500 to-brand-600 flex items-center justify-center shadow-lg shadow-brand-500/20">
                        <i class="fa-solid fa-earth-americas text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400 hidden md:block">
                            全球疏浚情报
                        </h1>
                        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400 md:hidden">
                            全球疏浚情报
                        </h1>
                        <p class="text-xs text-gray-400 hidden md:block">全球疏浚情报智能大屏</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <a href="/statistics.html" class="flex items-center justify-center gap-2 px-3 h-10 rounded-lg bg-white/5 border border-white/10 text-gray-200 hover:bg-white/10 transition-all text-sm font-medium whitespace-nowrap" title="统计分析">
                        <i class="fa-solid fa-chart-pie text-sm"></i>
                        <span>统计分析</span>
                    </a>
                    <a href="/history.html" class="flex items-center justify-center gap-2 px-3 h-10 rounded-lg bg-white/5 border border-white/10 text-gray-200 hover:bg-white/10 transition-all text-sm font-medium whitespace-nowrap" title="历史新闻">
                        <i class="fa-solid fa-clock-rotate-left text-sm"></i>
                        <span>历史新闻</span>
                    </a>
                    <a href="/vessel_map.html" target="_blank" class="flex items-center justify-center gap-2 px-0 md:px-3 w-10 md:w-auto h-10 rounded-lg bg-cyan-500/10 border border-cyan-500/20 text-cyan-400 hover:bg-cyan-500/20 transition-all text-sm font-medium whitespace-nowrap" title="全球船舶跟踪">
                        <i class="fa-solid fa-ship text-lg md:text-sm"></i> 
                        <span class="hidden md:inline">全球船舶跟踪</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>
    
    <main class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 space-y-6">
        
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="glass-card rounded-2xl p-5 flex items-center justify-between group">
                <div>
                    <p class="text-sm font-medium text-gray-400">本次情报</p>
                    <div class="flex items-end gap-2 mt-1">
                        <span class="text-3xl font-bold text-white group-hover:text-brand-400 transition-colors" id="current-count">0</span>
                        <span class="text-xs text-gray-500" id="history-total">/0</span>
                    </div>
                </div>
                <div class="w-12 h-12 rounded-full bg-blue-500/10 flex items-center justify-center">
                    <i class="fa-solid fa-bolt text-blue-400 text-xl"></i>
                </div>
            </div>
            <a href="/vessel_map.html" target="_blank" class="glass-card rounded-2xl p-5 flex items-center justify-between group hover:border-white/20 transition-colors">
                <div>
                    <p class="text-sm font-medium text-gray-400">跟踪船舶</p>
                    <div class="flex items-end gap-2 mt-1">
                        <span class="text-3xl font-bold text-white group-hover:text-green-400 transition-colors" id="tracked-count">0</span>
                        <span class="text-xs text-gray-500" id="ship-total">/0</span>
                    </div>
                </div>
                <div class="w-12 h-12 rounded-full bg-green-500/10 flex items-center justify-center">
                    <i class="fa-solid fa-ship text-green-400 text-xl"></i>
                </div>
            </a>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- Left Column: Quick Summary (Span 1) -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Quick Summary / Word Cloud Placeholder -->
                <div class="glass-card rounded-2xl p-6 h-full">
                    <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-bolt text-yellow-400"></i> 今日速览
                    </h3>
                    <div class="space-y-3" id="quick-summary-list">
                        <!-- Injected JS -->
                        <div class="animate-pulse flex space-x-4">
                            <div class="flex-1 space-y-4 py-1">
                                <div class="h-4 bg-slate-700 rounded w-3/4"></div>
                                <div class="h-4 bg-slate-700 rounded"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Categories Grid (Span 3) -->
            <div class="lg:col-span-3">
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="categories-grid">
                    <!-- Categories will be injected here -->
                </div>
            </div>
        </div>

    </main>

    <!-- Modal for Details -->
    <div id="detail-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        
        <!-- Modal Panel -->
        <div id="modal-wrapper" class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-2xl glass-card text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-slate-600">
                    
                    <!-- Header -->
                    <div class="px-6 py-4 border-b border-slate-700 flex justify-between items-start">
                        <h3 class="text-lg font-semibold leading-6 text-white pr-8" id="modal-title">Title</h3>
                        <button type="button" class="text-gray-400 hover:text-white transition-colors" onclick="closeModal()">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- Body -->
                    <div id="modal-body-scroll" class="px-6 py-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
                        <!-- Tags -->
                        <div class="flex flex-wrap gap-2 mb-4" id="modal-tags"></div>
                        
                        <!-- Content (Summary) -->
                        <div class="prose prose-invert prose-sm max-w-none text-gray-300" id="modal-content">
                            <!-- Content -->
                        </div>
                        
                        <!-- Image -->
                        <div id="modal-image-container" class="mt-6 hidden group relative cursor-pointer" onclick="openImageZoom()">
                            <img id="modal-image" src="" alt="Screenshot" class="w-full rounded-lg border border-slate-700 shadow-lg transition-transform hover:scale-[1.01]">
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 flex items-center justify-center transition-colors rounded-lg">
                                <i class="fa-solid fa-magnifying-glass-plus text-white/0 group-hover:text-white/80 text-3xl transition-all transform scale-50 group-hover:scale-100"></i>
                            </div>
                        </div>
                        
                        <div class="mt-6 bg-slate-900/50 rounded-lg p-4 border border-slate-700/50">
                            <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">原文翻译</h4>
                            <div id="modal-translation" class="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap"></div>
                        </div>

                        <!-- AI Analysis Section (Moved to Bottom) -->
                        <div class="mt-6 bg-slate-800/50 rounded-xl p-4 border border-brand-500/20">
                            <h4 class="text-sm font-bold text-brand-400 mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-robot"></i> AI 智能分析
                            </h4>
                            
                            <!-- Text LLM -->
                            <div class="mb-4">
                                <span class="text-xs text-gray-500 uppercase font-bold tracking-wider block mb-1">Qwen2.5 纯文字解析：</span>
                                <p class="text-gray-200 text-sm leading-relaxed" id="modal-summary-cn">Loading...</p>
                            </div>
                            
                            <!-- VL LLM -->
                            <div>
                                <span class="text-xs text-gray-500 uppercase font-bold tracking-wider block mb-1">Qwen3-VL多模态识别</span>
                                <p class="text-gray-300 text-sm leading-relaxed italic" id="modal-vl-desc">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="bg-slate-900/50 px-6 py-4 border-t border-slate-700 flex flex-row-reverse gap-3">
                        <a id="modal-link" href="#" target="_blank" class="inline-flex w-full h-9 justify-center rounded-lg bg-brand-600 px-3 text-sm font-semibold text-white shadow-sm hover:bg-brand-500 sm:ml-3 sm:w-auto transition-colors items-center gap-2">
                            <i class="fa-solid fa-external-link-alt"></i> 原文链接
                        </a>
                        <button type="button" class="inline-flex w-full h-9 justify-center rounded-lg bg-white/5 px-3 text-sm font-semibold text-gray-300 shadow-sm ring-1 ring-inset ring-gray-600 hover:bg-white/10 sm:w-auto transition-colors items-center" onclick="closeModal()">
                            关闭
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Zoom Modal -->
    <div id="image-zoom-modal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-black/90 backdrop-blur-md transition-opacity" onclick="closeImageZoom()"></div>
        <div class="fixed inset-0 z-10 overflow-auto flex items-center justify-center p-4">
            <button class="absolute top-4 right-4 text-white/50 hover:text-white transition-colors z-20" onclick="closeImageZoom()">
                <i class="fa-solid fa-xmark text-4xl"></i>
            </button>
            <img id="zoomed-image" src="" alt="Zoomed Screenshot" class="max-w-[95vw] max-h-[95vh] object-contain rounded-lg shadow-2xl transform transition-transform duration-300">
        </div>
    </div>

    <script>
        const DEFAULT_CATEGORY = "Project";
        const CATEGORIES = {
            "Market": { name: "市场动态", icon: "fa-chart-line", color: "text-blue-400", bg: "bg-blue-500/10", border: "border-blue-500/20" },
            "Bid": { name: "中标信息", icon: "fa-gavel", color: "text-yellow-400", bg: "bg-yellow-500/10", border: "border-yellow-500/20" },
            "Project": { name: "项目信息", icon: "fa-building", color: "text-green-400", bg: "bg-green-500/10", border: "border-green-500/20" },
            // "VesselDist": Removed from grid, moved to Navbar
            "Equipment": { name: "设备修造", icon: "fa-gears", color: "text-orange-400", bg: "bg-orange-500/10", border: "border-orange-500/20" },
            "R&D": { name: "科技研发", icon: "fa-flask", color: "text-purple-400", bg: "bg-purple-500/10", border: "border-purple-500/20" },
            "Regulation": { name: "技术法规", icon: "fa-scale-balanced", color: "text-red-400", bg: "bg-red-500/10", border: "border-red-500/20" }
        };

        window.eventCache = [];
        window.sourcesMap = {};
        window.sourcesMapLoaded = false;
        
        function openModalFromCache(idx) {
            const data = window.eventCache[idx];
            if (data) openModal(data);
        }

        let chartInstance = null;

        const now = new Date();
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');
        const dateParam = urlParams.get('date');
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        window.currentMode = mode === 'recent' ? 'recent' : 'date';
        window.currentDate = dateParam || `${year}-${month}-${day}`;

        async function fetchData() {
            if (!window.sourcesMapLoaded) {
                const sourcesRes = await fetch('/api/sources');
                const sourcesData = await sourcesRes.json();
                window.sourcesMap = {};
                (sourcesData.sources || []).forEach(s => {
                    if (s && s.name) {
                        window.sourcesMap[s.name] = s;
                    }
                });
                window.sourcesMapLoaded = true;
            }
            let url = '/api/events';
            if (window.currentMode === 'recent') {
                url += '?mode=recent';
            } else {
                url += `?date=${window.currentDate}`;
            }

            const res = await fetch(url);
            const data = await res.json();
            renderDashboard(data);
            updateStats(data);
        }

        async function fetchStats() {
            const [statsRes, shipsRes] = await Promise.all([
                fetch('/api/stats'),
                fetch('/api/ships')
            ]);
            const statsData = await statsRes.json();
            const shipsData = await shipsRes.json();
            
            if (statsData.total_history !== undefined) {
                const historyEl = document.getElementById('history-total');
                if (historyEl) historyEl.innerText = `/${statsData.total_history}`;
            }
            if (shipsData.total !== undefined) {
                const shipTotalEl = document.getElementById('ship-total');
                if (shipTotalEl) shipTotalEl.innerText = `/${shipsData.total}`;
            }
            if (shipsData.tracked !== undefined) {
                const trackedEl = document.getElementById('tracked-count');
                if (trackedEl) trackedEl.innerText = shipsData.tracked;
            }

            renderChart(statsData);
        }

        function updateStats(data) {
            // Update total count
            const totalCountEl = document.getElementById('current-count');
            if (totalCountEl) {
                const currentCount = data.article_count ?? data.count ?? 0;
                totalCountEl.innerText = currentCount;
            }
            
            // Ensure data.date is a valid string, if not use current date
            let displayDate = data.date;
            if (!displayDate || displayDate.includes('/0') || displayDate.includes('undefined')) {
                const now = new Date();
                displayDate = now.getFullYear() + '-' + 
                             String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                             String(now.getDate()).padStart(2, '0');
                console.warn('Invalid date received from API, falling back to:', displayDate);
            }
            
            // Log for debugging
            console.log('Updating dashboard with date label:', displayDate);
        }

        function normalizeCountryName(raw) {
            if (!raw) return '';
            const text = raw.toString().trim();
            const lower = text.toLowerCase();
            const directMap = {
                "usa": "美国",
                "u.s.a": "美国",
                "u.s.": "美国",
                "us": "美国",
                "united states": "美国",
                "united states of america": "美国",
                "uk": "英国",
                "u.k.": "英国",
                "united kingdom": "英国",
                "china": "中国",
                "prc": "中国",
                "netherlands": "荷兰",
                "holland": "荷兰",
                "australia": "澳大利亚",
                "canada": "加拿大",
                "germany": "德国",
                "france": "法国",
                "spain": "西班牙",
                "italy": "意大利",
                "japan": "日本",
                "korea": "韩国",
                "south korea": "韩国",
                "united arab emirates": "阿联酋",
                "uae": "阿联酋",
                "singapore": "新加坡",
                "malaysia": "马来西亚",
                "indonesia": "印度尼西亚",
                "india": "印度",
                "brazil": "巴西"
            };
            if (directMap[lower]) return directMap[lower];
            if (/中国|美国|英国|荷兰|澳大利亚|加拿大|德国|法国|西班牙|意大利|日本|韩国|阿联酋|新加坡|马来西亚|印度尼西亚|印度|巴西/.test(text)) {
                return text;
            }
            return '';
        }

        function normalizeRegionName(raw) {
            if (!raw) return '';
            const text = raw.toString().trim();
            const lower = text.toLowerCase();
            const usStateMap = {
                "texas": "德克萨斯",
                "florida": "佛罗里达",
                "california": "加利福尼亚",
                "new york": "纽约",
                "louisiana": "路易斯安那",
                "virginia": "弗吉尼亚",
                "north carolina": "北卡罗来纳",
                "south carolina": "南卡罗来纳",
                "georgia": "佐治亚",
                "alabama": "阿拉巴马",
                "mississippi": "密西西比",
                "washington": "华盛顿州",
                "oregon": "俄勒冈",
                "alaska": "阿拉斯加",
                "hawaii": "夏威夷",
                "new jersey": "新泽西",
                "massachusetts": "马萨诸塞",
                "ohio": "俄亥俄",
                "illinois": "伊利诺伊",
                "pennsylvania": "宾夕法尼亚"
            };
            if (usStateMap[lower]) return usStateMap[lower];
            return text;
        }

        function formatProjectLocation(location, sourceCountry) {
            const loc = location ? location.toString().trim() : '';
            let country = normalizeCountryName(sourceCountry);
            let region = '';
            if (loc) {
                const cnPrefixMatch = loc.match(/^(中国|美国|英国|荷兰|澳大利亚|加拿大|德国|法国|西班牙|意大利|日本|韩国|阿联酋|新加坡|马来西亚|印度尼西亚|印度|巴西)/);
                if (cnPrefixMatch) {
                    country = country || cnPrefixMatch[0];
                    region = loc.slice(cnPrefixMatch[0].length).replace(/^[:：,\s，-]+/, '');
                } else {
                    const parts = loc.split(/[,，/|]/).map(p => p.trim()).filter(Boolean);
                    let countryFromParts = '';
                    parts.forEach(p => {
                        if (!countryFromParts) {
                            const c = normalizeCountryName(p);
                            if (c) countryFromParts = c;
                        }
                    });
                    if (!country && countryFromParts) country = countryFromParts;
                    const regionParts = parts.filter(p => normalizeCountryName(p) !== countryFromParts);
                    region = (regionParts[0] || '').trim();
                }
            }
            region = normalizeRegionName(region);
            if (country && region) return `${country}，${region}`;
            if (country) return country;
            return region;
        }

        function renderDashboard(data) {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = '';

            // Group events by Category -> Article
            const grouped = {};
            Object.keys(CATEGORIES).forEach(k => grouped[k] = {});
            
            // Filter out "back to home" and "VesselDist" (moved to separate page)
            const filteredEvents = data.events.filter(e => {
                const title = (e.title_cn || e.article_title || "").toLowerCase();
                const cat = e.category || DEFAULT_CATEGORY;
                return !title.includes("back to home") && !title.includes("page not found") && cat !== 'VesselDist';
            });

            filteredEvents.forEach(e => {
                let cat = e.category || DEFAULT_CATEGORY;
                if (!CATEGORIES[cat]) cat = DEFAULT_CATEGORY;
                
                if (!grouped[cat]) grouped[cat] = {}; 

                // Group by Article ID (preferred) or URL
                const groupKey = e.article_id || e.article_url || e.article_title;
                
                if (!grouped[cat][groupKey]) {
                    grouped[cat][groupKey] = {
                        main: e,
                        events: []
                    };
                }
                grouped[cat][groupKey].events.push(e);
            });

            // Reset Event Cache
            window.eventCache = [];

            // Render cards
            Object.entries(CATEGORIES).forEach(([key, meta]) => {
                const articlesMap = grouped[key] || {};
                const articleGroups = Object.values(articlesMap);
                
                const card = document.createElement('div');
                card.className = `glass-card rounded-xl flex flex-col md:h-[400px] min-h-[120px] overflow-hidden transition-all duration-300 hover:shadow-lg hover:shadow-${meta.color.split('-')[1]}-500/10 border-t-2 ${meta.border.replace('border-', 'border-t-')}`;
                
                // Card Header
                const header = `
                    <div class="p-4 border-b border-white/5 flex justify-between items-center bg-white/5">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg ${meta.bg} flex items-center justify-center">
                                <i class="fa-solid ${meta.icon} ${meta.color}"></i>
                            </div>
                            <h3 class="font-bold text-gray-200">${meta.name}</h3>
                        </div>
                        <span class="text-xs font-mono bg-slate-800 px-2 py-1 rounded text-gray-400">${articleGroups.length}</span>
                    </div>
                `;

                // Card Body
                let bodyContent = '';
                if (articleGroups.length === 0) {
                    bodyContent = '';
                } else {
                    const listItems = articleGroups.map(group => {
                        const e = group.main;
                        const subEvents = group.events;
                        const multipleBadge = subEvents.length > 1 ? `<span class="text-[10px] bg-white/10 px-1.5 py-0.5 rounded ml-2 text-gray-400" title="包含 ${subEvents.length} 个相关事件">+${subEvents.length}</span>` : '';
                        
                        // Title Logic
                        let displayTitle = e.title_cn || e.summary_cn || e.article_title;
                        if (displayTitle.length > 50) displayTitle = displayTitle.substring(0, 50) + '...';
                        
                        // Category Specific Title Prefixes
                        if (key === 'Bid' && e.contractor) {
                            displayTitle = `<span class="text-yellow-500">[中标: ${e.contractor}]</span> ${displayTitle}`;
                        } else if (key === 'Project') {
                            const formattedLoc = formatProjectLocation(e.location, e.source_country);
                            if (formattedLoc) {
                                displayTitle = `<span class="text-green-500">[${formattedLoc}]</span> ${displayTitle}`;
                            }
                        }

                        // Prepare data for modal (Use Cache)
                        const modalData = {
                            main: e,
                            events: subEvents
                        };
                        const cacheIdx = window.eventCache.push(modalData) - 1;

                        const titleClass = 'line-clamp-2';

                        return `
                            <div onclick='openModalFromCache(${cacheIdx})' 
                                 class="p-3 rounded-lg hover:bg-white/5 cursor-pointer transition-colors group border border-transparent hover:border-white/5">
                                <div class="flex justify-between items-start">
                                    <h4 class="text-sm font-medium text-gray-300 group-hover:text-white ${titleClass} leading-snug">
                                        ${displayTitle}
                                        ${multipleBadge}
                                    </h4>
                                    <span class="text-[10px] text-gray-500 whitespace-nowrap ml-2 mt-0.5">${new Date(e.created_at).toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'})}</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1 line-clamp-1 group-hover:text-gray-400">
                                    ${e.summary_cn || e.article_title}
                                </p>
                            </div>
                        `;
                    }).join('');
                    bodyContent = `<div class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1">${listItems}</div>`;
                }

                card.innerHTML = header + bodyContent;
                grid.appendChild(card);
            });

            const summaryList = document.getElementById('quick-summary-list');
            
            // Deduplicate events by article title for summary
            const seenTitles = new Set();
            const uniqueEvents = [];
            filteredEvents.forEach(e => {
                const title = e.title_cn || e.article_title;
                if (!seenTitles.has(title)) {
                    seenTitles.add(title);
                    uniqueEvents.push(e);
                }
            });

            const topEvents = uniqueEvents.slice(0, 5);
            
            summaryList.innerHTML = '';
            topEvents.forEach(e => {
                let catKey = e.category || DEFAULT_CATEGORY;
                if (!CATEGORIES[catKey]) catKey = DEFAULT_CATEGORY;
                const catMeta = CATEGORIES[catKey];
                
                const item = document.createElement('div');
                item.className = 'bg-white/5 rounded-lg p-3 border border-white/5 hover:border-brand-500/20 transition-colors cursor-pointer';
                
                const modalData = { main: e, events: [e] };
                const cacheIdx = window.eventCache.push(modalData) - 1;
                
                item.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="w-6 h-6 rounded-lg ${catMeta.bg} flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fa-solid ${catMeta.icon} ${catMeta.color} text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-gray-200 line-clamp-1">${e.title_cn || e.article_title}</h4>
                            <p class="text-xs text-gray-400 mt-1 line-clamp-1">${e.summary_cn || '暂无摘要'}</p>
                        </div>
                    </div>
                `;
                item.setAttribute('onclick', `openModalFromCache(${cacheIdx})`);
                summaryList.appendChild(item);
            });
        }

        function renderChart(data) {
            // Chart rendering logic (removed as 情报趋势 section is deleted)
        }

        function openModal(data) {
            const event = data.main || data; // Fallback
            const subEvents = data.events || [event];

            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalTags = document.getElementById('modal-tags');
            const modalImage = document.getElementById('modal-image');
            const modalImageContainer = document.getElementById('modal-image-container');
            const modalLink = document.getElementById('modal-link');
            const modalTranslation = document.getElementById('modal-translation');
            const modalSummaryCn = document.getElementById('modal-summary-cn');
            const modalVlDesc = document.getElementById('modal-vl-desc');

            // Set modal content
            modalTitle.innerText = event.title_cn || event.article_title;
            modalContent.innerHTML = ''; 
            
            // 1. Article Summary (if any)
            if (event.summary_cn) {
                 modalContent.innerHTML += `<div class="mb-4 font-medium text-gray-300">${event.summary_cn}</div>`;
            }

            // 2. Sub-events Details
            if (subEvents.length > 0) {
                modalContent.innerHTML += `<h5 class="text-sm font-bold text-brand-400 mb-2 mt-4 border-b border-brand-500/20 pb-1">包含事件详情 (${subEvents.length})</h5>`;
                modalContent.innerHTML += `<div class="space-y-4">`;
                subEvents.forEach((sub, idx) => {
                    let detailsHtml = '';
                    const fields = [
                        { k: 'project_name', l: '项目名称' },
                        { k: 'time', l: '时间' },
                        { k: 'location', l: '地点' },
                        { k: 'content', l: '内容' },
                        { k: 'contractor', l: '承建商' },
                        { k: 'client', l: '业主' },
                        { k: 'amount', l: '金额' },
                        { k: 'currency', l: '货币' }
                    ];
                    
                    fields.forEach(f => {
                        if (sub[f.k]) {
                            detailsHtml += `<div class="flex text-xs"><span class="w-20 text-gray-500 flex-shrink-0">${f.l}:</span><span class="text-gray-300">${sub[f.k]}</span></div>`;
                        }
                    });

                    if (sub.details) {
                        Object.entries(sub.details).forEach(([k, v]) => {
                            if (v && typeof v !== 'object') {
                                 detailsHtml += `<div class="flex text-xs"><span class="w-20 text-gray-500 flex-shrink-0 truncate" title="${k}">${k}:</span><span class="text-gray-300 line-clamp-2" title="${v}">${v}</span></div>`;
                            }
                        });
                    }

                    modalContent.innerHTML += `
                        <div class="bg-white/5 rounded p-3 border border-white/5">
                            <div class="font-bold text-xs text-gray-400 mb-2">#${idx + 1} ${sub.category || 'Event'}</div>
                            <div class="space-y-1">${detailsHtml || '<span class="text-gray-500 text-xs">无详细字段</span>'}</div>
                        </div>
                    `;
                });
                modalContent.innerHTML += `</div>`;
            }

            modalLink.href = event.article_url || '#';
            const translationParts = [];
            if (event.title_cn && event.title_cn !== event.article_title) translationParts.push(event.title_cn);
            if (event.summary_cn) translationParts.push(event.summary_cn);
            modalTranslation.innerText = translationParts.join('\n') || '暂无翻译内容';
            modalSummaryCn.innerText = event.summary_cn || '暂无摘要';
            modalVlDesc.innerText = event.vl_desc || '暂无视觉分析数据';

            // Set tags
            modalTags.innerHTML = '';
            const catMeta = CATEGORIES[event.category || DEFAULT_CATEGORY];
            const catTag = document.createElement('span');
            catTag.className = `px-2 py-1 rounded-full text-xs ${catMeta.bg} ${catMeta.color} border ${catMeta.border}`;
            catTag.innerText = catMeta.name;
            modalTags.appendChild(catTag);

            const sourceName = (event.source_name || '').trim();
            if (sourceName) {
                const sourceInfo = window.sourcesMap[sourceName];
                const nameTag = document.createElement(sourceInfo && sourceInfo.url ? 'a' : 'span');
                if (sourceInfo && sourceInfo.url) {
                    nameTag.href = sourceInfo.url;
                    nameTag.target = '_blank';
                    nameTag.rel = 'noopener noreferrer';
                    nameTag.className = 'px-2 py-1 rounded-full text-xs bg-white/5 text-gray-300 border border-white/10 hover:bg-white/10 transition-colors';
                } else {
                    nameTag.className = 'px-2 py-1 rounded-full text-xs bg-white/5 text-gray-300 border border-white/10';
                }
                nameTag.innerText = sourceName.length > 5 ? sourceName.slice(0, 5) : sourceName;
                modalTags.appendChild(nameTag);
            }
            const sourceTypeRaw = (event.source_type || '').toLowerCase();
            const sourceType = sourceTypeRaw === 'rss' ? 'RSS' : 'Origin';
            const sourceTag = document.createElement('span');
            sourceTag.className = 'px-2 py-1 rounded-full text-xs bg-white/5 text-gray-300 border border-white/10';
            sourceTag.innerText = sourceType;
            modalTags.appendChild(sourceTag);

            // Set image
            if (event.screenshot_path) {
                modalImage.src = event.screenshot_path;
                modalImageContainer.classList.remove('hidden');
            } else {
                modalImageContainer.classList.add('hidden');
            }

            // Show modal
            document.getElementById('detail-modal').classList.remove('hidden');
            
            // Reset scroll position (Robust fix using requestAnimationFrame)
            requestAnimationFrame(() => {
                 const bodyScroll = document.getElementById('modal-body-scroll');
                 if (bodyScroll) bodyScroll.scrollTop = 0;
                 
                 const wrapper = document.getElementById('modal-wrapper');
                 if (wrapper) wrapper.scrollTop = 0;
            });
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        function openImageZoom(src) {
            const img = document.getElementById('modal-image');
            const zoomModal = document.getElementById('image-zoom-modal');
            const zoomedImg = document.getElementById('zoomed-image');
            
            if (src) {
                zoomedImg.src = src;
            } else if (img && img.src) {
                zoomedImg.src = img.src;
            } else {
                return;
            }
            
            zoomModal.classList.remove('hidden');
        }

        function closeImageZoom() {
            document.getElementById('image-zoom-modal').classList.add('hidden');
        }

        // Initial load
        fetchData();
        fetchStats();
    </script>
</body>
</html>
