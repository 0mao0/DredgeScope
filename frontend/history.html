<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史新闻 - 全球疏浚情报</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans SC"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            border: '#334155',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glass-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.4);
            border-radius: 8px;
        }
    </style>
</head>
<body class="min-h-screen font-sans antialiased selection:bg-brand-500 selection:text-white pb-10 bg-dark-bg text-white">
    <nav class="sticky top-0 z-40 w-full glass-card border-b border-white/5 mb-6">
        <div class="w-full px-6">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-brand-500 to-brand-600 flex items-center justify-center shadow-lg shadow-brand-500/20">
                        <i class="fa-solid fa-earth-americas text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400 hidden md:block">
                            全球疏浚情报
                        </h1>
                        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400 md:hidden">
                            全球疏浚情报
                        </h1>
                        <p class="text-xs text-gray-400 hidden md:block">历史新闻综合查看</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <a href="/" class="flex items-center justify-center gap-1 md:gap-2 px-2 md:px-3 h-10 rounded-lg bg-white/5 border border-white/10 text-gray-200 hover:bg-white/10 transition-all text-sm font-medium whitespace-nowrap">
                        <i class="fa-solid fa-arrow-left text-sm"></i>
                        <span class="hidden md:inline">返回首页</span>
                    </a>
                    <a href="/statistics.html" class="flex items-center justify-center gap-1 md:gap-2 px-2 md:px-3 h-10 rounded-lg bg-white/5 border border-white/10 text-gray-200 hover:bg-white/10 transition-all text-sm font-medium whitespace-nowrap" title="统计分析">
                        <i class="fa-solid fa-chart-pie text-sm"></i>
                        <span class="hidden md:inline">统计分析</span>
                    </a>
                    <a href="/vessel_map.html" target="_blank" class="flex items-center justify-center gap-1 md:gap-2 px-2 md:px-3 h-10 rounded-lg bg-cyan-500/10 border border-cyan-500/20 text-cyan-400 hover:bg-cyan-500/20 transition-all text-sm font-medium whitespace-nowrap" title="全球船舶跟踪">
                        <i class="fa-solid fa-ship text-lg md:text-sm"></i> 
                        <span class="hidden md:inline">全球船舶跟踪</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="w-full px-6 space-y-6">
        <div class="glass-card rounded-2xl p-5">
            <div class="flex flex-wrap items-end gap-3">
                <div class="flex flex-col">
                    <label class="text-xs text-gray-400 mb-1">时间范围</label>
                    <div id="date-range" class="flex items-center bg-dark-card border border-dark-border rounded-lg overflow-hidden h-[42px] cursor-pointer">
                        <input id="filter-start-date" type="date" class="bg-transparent border-none text-white text-sm focus:ring-0 w-32 px-2 h-full">
                        <span class="text-gray-500 px-1">-</span>
                        <input id="filter-end-date" type="date" class="bg-transparent border-none text-white text-sm focus:ring-0 w-32 px-2 h-full">
                    </div>
                </div>
                <div class="w-40 sm:flex-1 sm:min-w-[200px]">
                    <label class="text-xs text-gray-400">关键词</label>
                    <input id="filter-keyword" type="text" placeholder="标题/摘要关键词" class="mt-1 bg-dark-card border border-dark-border text-white text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block w-full p-2.5">
                </div>
                <div class="w-40">
                    <label class="text-xs text-gray-400">分类</label>
                    <select id="filter-category" class="mt-1 bg-dark-card border border-dark-border text-white text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block w-full p-2.5">
                        <option value="">全部</option>
                        <option value="Market">市场动态</option>
                        <option value="Bid">中标信息</option>
                        <option value="Project">项目信息</option>
                        <option value="Equipment">设备修造</option>
                        <option value="R&D">科技研发</option>
                        <option value="Regulation">技术法规</option>
                    </select>
                </div>
                <div class="w-44">
                    <label class="text-xs text-gray-400">网站</label>
                    <select id="filter-source-name" class="mt-1 bg-dark-card border border-dark-border text-white text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block w-full p-2.5">
                        <option value="">全部</option>
                    </select>
                </div>
                <div class="w-32">
                    <label class="text-xs text-gray-400">来源类型</label>
                    <select id="filter-source-type" class="mt-1 bg-dark-card border border-dark-border text-white text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block w-full p-2.5">
                        <option value="">全部</option>
                        <option value="rss">RSS</option>
                        <option value="web">Origin</option>
                    </select>
                </div>
                <button id="reset-btn" class="ml-auto inline-flex items-center gap-2 px-4 h-10 rounded-lg bg-white/5 text-gray-200 text-sm font-semibold hover:bg-white/10 transition-colors">
                    重置
                </button>
            </div>
        </div>

        <div class="space-y-4" id="history-list"></div>

        <div class="flex items-center justify-between text-sm text-gray-400">
            <span id="pagination-info">共 0 条</span>
            <div class="flex items-center gap-2">
                <button id="prev-page" class="px-3 h-9 rounded-lg bg-white/5 hover:bg-white/10 text-gray-200 disabled:opacity-40 disabled:cursor-not-allowed">上一页</button>
                <button id="next-page" class="px-3 h-9 rounded-lg bg-white/5 hover:bg-white/10 text-gray-200 disabled:opacity-40 disabled:cursor-not-allowed">下一页</button>
            </div>
        </div>
    </main>

    <div id="detail-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div id="modal-wrapper" class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-2xl glass-card text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-slate-600">
                    <div class="px-6 py-4 border-b border-slate-700 flex justify-between items-start">
                        <h3 class="text-lg font-semibold leading-6 text-white pr-8" id="modal-title">Title</h3>
                        <button type="button" class="text-gray-400 hover:text-white transition-colors" onclick="closeModal()">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>
                    <div id="modal-body-scroll" class="px-6 py-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
                        <div class="flex flex-wrap gap-2 mb-4" id="modal-tags"></div>
                        <div class="prose prose-invert prose-sm max-w-none text-gray-300" id="modal-content"></div>
                        <div id="modal-events" class="mt-4 space-y-3"></div>
                        <div id="modal-image-container" class="mt-6 hidden group relative cursor-pointer" onclick="openImageZoom()">
                            <img id="modal-image" src="" alt="Screenshot" class="w-full rounded-lg border border-slate-700 shadow-lg transition-transform hover:scale-[1.01]">
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 flex items-center justify-center transition-colors rounded-lg">
                                <i class="fa-solid fa-magnifying-glass-plus text-white/0 group-hover:text-white/80 text-3xl transition-all transform scale-50 group-hover:scale-100"></i>
                            </div>
                        </div>
                        <div class="mt-6 bg-slate-900/50 rounded-lg p-4 border border-slate-700/50">
                            <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">原文翻译</h4>
                            <div id="modal-translation" class="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap"></div>
                        </div>
                        <div class="mt-6 bg-slate-800/50 rounded-xl p-4 border border-brand-500/20">
                            <h4 class="text-sm font-bold text-brand-400 mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-robot"></i> AI 智能分析
                            </h4>
                            <div class="mb-4">
                                <span class="text-xs text-gray-500 uppercase font-bold tracking-wider block mb-1">Qwen2.5 纯文字解析：</span>
                                <p class="text-gray-200 text-sm leading-relaxed" id="modal-summary-cn">Loading...</p>
                            </div>
                            <div>
                                <span class="text-xs text-gray-500 uppercase font-bold tracking-wider block mb-1">Qwen3-VL多模态识别</span>
                                <p class="text-gray-300 text-sm leading-relaxed italic" id="modal-vl-desc">Loading...</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-900/50 px-6 py-4 border-t border-slate-700 flex flex-row-reverse gap-3">
                        <a id="modal-link" href="#" target="_blank" class="inline-flex w-full h-9 justify-center rounded-lg bg-brand-600 px-3 text-sm font-semibold text-white shadow-sm hover:bg-brand-500 sm:ml-3 sm:w-auto transition-colors items-center gap-2">
                            <i class="fa-solid fa-external-link-alt"></i> 原文链接
                        </a>
                        <button type="button" class="inline-flex w-full h-9 justify-center rounded-lg bg-white/5 px-3 text-sm font-semibold text-gray-300 shadow-sm ring-1 ring-inset ring-gray-600 hover:bg-white/10 sm:w-auto transition-colors items-center" onclick="closeModal()">
                            关闭
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="image-zoom-modal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-black/90 backdrop-blur-md transition-opacity" onclick="closeImageZoom()"></div>
        <div class="fixed inset-0 z-10 overflow-auto flex items-center justify-center p-4">
            <button class="absolute top-4 right-4 text-white/50 hover:text-white transition-colors z-20" onclick="closeImageZoom()">
                <i class="fa-solid fa-xmark text-4xl"></i>
            </button>
            <img id="zoomed-image" src="" alt="Zoomed Screenshot" class="max-w-[95vw] max-h-[95vh] object-contain rounded-lg shadow-2xl transform transition-transform duration-300">
        </div>
    </div>

    <script>
        const CATEGORY_LABELS = {
            "Market": "市场动态",
            "Bid": "中标信息",
            "Project": "项目信息",
            "Equipment": "设备修造",
            "R&D": "科技研发",
            "Regulation": "技术法规"
        };

        const state = {
            page: 1,
            pageSize: 20,
            total: 0,
            startDate: '',
            endDate: '',
            keyword: '',
            category: '',
            sourceType: '',
            sourceName: ''
        };

        let sourcesMap = {};
        let debounceTimer = null;

        function buildEventSignature(evt) {
            if (!evt) return '';
            const parts = [
                evt.category,
                evt.project_name,
                evt.location,
                evt.contractor,
                evt.client,
                evt.time,
                evt.content
            ];
            return parts.map(v => (v || '').toString().trim().toLowerCase()).filter(Boolean).join('|');
        }

        function dedupeEvents(events) {
            const seen = new Set();
            const result = [];
            events.forEach(evt => {
                const key = buildEventSignature(evt);
                if (!key || !seen.has(key)) {
                    if (key) seen.add(key);
                    result.push(evt);
                }
            });
            return result;
        }

        function setDefaultDates() {
            const now = new Date();
            const endDate = new Date(now);
            const startDate = new Date(now);
            startDate.setDate(startDate.getDate() - 29);
            const endVal = endDate.toISOString().slice(0, 10);
            const startVal = startDate.toISOString().slice(0, 10);
            document.getElementById('filter-start-date').value = startVal;
            document.getElementById('filter-end-date').value = endVal;
        }

        function bindDateRangePicker(rangeId, startId, endId) {
            const range = document.getElementById(rangeId);
            const startInput = document.getElementById(startId);
            const endInput = document.getElementById(endId);
            if (!range || !startInput || !endInput) return;
            const openPicker = (input) => {
                input.focus();
                if (typeof input.showPicker === 'function') {
                    input.showPicker();
                }
            };
            range.addEventListener('click', (event) => {
                if (event.target === startInput || event.target === endInput) return;
                const rect = range.getBoundingClientRect();
                const isLeft = (event.clientX - rect.left) < rect.width / 2;
                openPicker(isLeft ? startInput : endInput);
            });
        }

        function syncStateFromForm() {
            state.startDate = document.getElementById('filter-start-date').value || '';
            state.endDate = document.getElementById('filter-end-date').value || '';
            state.keyword = document.getElementById('filter-keyword').value.trim();
            state.category = document.getElementById('filter-category').value;
            state.sourceType = document.getElementById('filter-source-type').value;
            state.sourceName = document.getElementById('filter-source-name').value;
        }

        function buildQuery() {
            const params = new URLSearchParams();
            if (state.startDate && state.endDate) {
                params.set('start', state.startDate);
                params.set('end', state.endDate);
            }
            if (state.keyword) params.set('keyword', state.keyword);
            if (state.category) params.set('category', state.category);
            if (state.sourceType) params.set('source_type', state.sourceType);
            if (state.sourceName) params.set('source_name', state.sourceName);
            params.set('page', state.page);
            params.set('page_size', state.pageSize);
            return params.toString();
        }

        function formatDate(value) {
            if (!value) return '';
            return value.replace('T', ' ').slice(0, 16);
        }

        function renderList(items) {
            const list = document.getElementById('history-list');
            if (!items.length) {
                list.innerHTML = `<div class="glass-card rounded-2xl p-6 text-center text-gray-400">暂无匹配的历史新闻</div>`;
                return;
            }
            list.innerHTML = items.map(item => {
                const title = item.title_cn || item.title || '未命名';
                const summary = item.summary_cn || '';
                const cats = (item.categories || []).map(cat => {
                    const label = CATEGORY_LABELS[cat] || cat;
                    return `<span class="px-2 py-1 rounded-full text-xs bg-brand-500/10 text-brand-300 border border-brand-500/30">${label}</span>`;
                }).join('');
                const sourceName = item.source_name ? item.source_name.slice(0, 5) : '';
                const sourceType = (item.source_type || '').toLowerCase() === 'rss' ? 'RSS' : 'Origin';
                const sourceInfo = sourcesMap[item.source_name];
                const sourceUrl = sourceInfo ? sourceInfo.url : '';
                const sourceTag = sourceName ? (sourceUrl ? `<a href="${sourceUrl}" target="_blank" class="stop-prop px-2 py-1 rounded-full text-xs bg-cyan-500/10 text-cyan-300 border border-cyan-500/30">${sourceName}</a>` : `<span class="px-2 py-1 rounded-full text-xs bg-cyan-500/10 text-cyan-300 border border-cyan-500/30">${sourceName}</span>`) : '';
                const sourceTypeTag = `<span class="px-2 py-1 rounded-full text-xs bg-purple-500/10 text-purple-300 border border-purple-500/30">${sourceType}</span>`;
                return `
                    <div class="glass-card rounded-2xl p-5 cursor-pointer hover:border-brand-500/20 transition-colors" data-article-id="${item.id}">
                        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                            <div class="space-y-2">
                                <h3 class="text-lg font-semibold text-brand-300">${title}</h3>
                                <div class="flex flex-wrap gap-2">${cats}${sourceTag}${sourceTypeTag}</div>
                                <p class="text-sm text-gray-300 leading-relaxed">${summary || '暂无摘要'}</p>
                                <div class="text-xs text-gray-500">发布时间：${item.pub_date || '未知'} · 入库时间：${formatDate(item.created_at)}</div>
                            </div>
                            <div class="flex-shrink-0">
                                <a href="${item.url || '#'}" target="_blank" class="stop-prop text-sm text-blue-400 hover:text-blue-300 transition-colors">
                                    原文链接
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updatePagination() {
            const info = document.getElementById('pagination-info');
            info.innerText = `共 ${state.total} 条 · 第 ${state.page} 页`;
            const prev = document.getElementById('prev-page');
            const next = document.getElementById('next-page');
            prev.disabled = state.page <= 1;
            const maxPage = Math.ceil(state.total / state.pageSize) || 1;
            next.disabled = state.page >= maxPage;
        }

        async function fetchSources() {
            const res = await fetch('/api/sources');
            const data = await res.json();
            const select = document.getElementById('filter-source-name');
            sourcesMap = {};
            (data.sources || []).forEach(source => {
                sourcesMap[source.name] = source;
                const option = document.createElement('option');
                option.value = source.name;
                option.textContent = source.name;
                select.appendChild(option);
            });
        }

        async function fetchArticles() {
            const query = buildQuery();
            const res = await fetch(`/api/articles?${query}`);
            const data = await res.json();
            state.total = data.total || 0;
            renderList(data.items || []);
            updatePagination();
        }

        function scheduleSearch() {
            if (debounceTimer) clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                syncStateFromForm();
                state.page = 1;
                fetchArticles();
            }, 300);
        }

        function normalizeText(value) {
            return (value || '').replace(/\s+/g, '').trim();
        }

        function buildVlSupplement(textSummary, vlDesc) {
            const summary = normalizeText(textSummary);
            const raw = (vlDesc || '').trim();
            if (!raw) return '无补充';
            if (!summary) return `补充：${raw}`;
            const parts = raw.split(/[。！？!?；;]+/).map(p => p.trim()).filter(Boolean);
            const supplements = parts.filter(p => !summary.includes(normalizeText(p)));
            if (!supplements.length) return '无补充';
            return `补充：${supplements.join('；')}`;
        }

        async function openModalById(articleId) {
            const res = await fetch(`/api/article/${articleId}`);
            const data = await res.json();
            if (!data.article) return;
            openModal(data);
        }

        function openModal(data) {
            const article = data.article;
            const events = dedupeEvents(data.events || []);
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalTags = document.getElementById('modal-tags');
            const modalImage = document.getElementById('modal-image');
            const modalImageContainer = document.getElementById('modal-image-container');
            const modalLink = document.getElementById('modal-link');
            const modalTranslation = document.getElementById('modal-translation');
            const modalEvents = document.getElementById('modal-events');
            const modalSummaryCn = document.getElementById('modal-summary-cn');
            const modalVlDesc = document.getElementById('modal-vl-desc');

            modalTitle.innerText = article.title_cn || article.title;
            modalContent.innerHTML = article.summary_cn ? `<div class="mb-4 font-medium text-gray-300">${article.summary_cn}</div>` : '';

            modalTags.innerHTML = '';
            const categorySet = new Set(data.categories || []);
            events.forEach(evt => {
                if (evt.category) categorySet.add(evt.category);
            });
            categorySet.forEach(cat => {
                const label = CATEGORY_LABELS[cat] || cat;
                const tag = document.createElement('span');
                tag.className = 'px-2 py-1 rounded-full text-xs bg-brand-500/10 text-brand-300 border border-brand-500/30';
                tag.innerText = label;
                modalTags.appendChild(tag);
            });

            const sourceName = (article.source_name || '').trim();
            if (sourceName) {
                const sourceInfo = sourcesMap[sourceName];
                const tag = document.createElement(sourceInfo && sourceInfo.url ? 'a' : 'span');
                if (sourceInfo && sourceInfo.url) {
                    tag.href = sourceInfo.url;
                    tag.target = '_blank';
                }
                tag.className = 'px-2 py-1 rounded-full text-xs bg-cyan-500/10 text-cyan-300 border border-cyan-500/30';
                tag.innerText = sourceName.length > 5 ? sourceName.slice(0, 5) : sourceName;
                modalTags.appendChild(tag);
            }

            const sourceTypeRaw = (article.source_type || '').toLowerCase();
            const sourceType = sourceTypeRaw === 'rss' ? 'RSS' : 'Origin';
            const sourceTag = document.createElement('span');
            sourceTag.className = 'px-2 py-1 rounded-full text-xs bg-purple-500/10 text-purple-300 border border-purple-500/30';
            sourceTag.innerText = sourceType;
            modalTags.appendChild(sourceTag);

            modalEvents.innerHTML = '';
            if (events.length) {
                events.forEach((sub, idx) => {
                    let detailsHtml = '';
                    const fields = [
                        { k: 'project_name', l: '项目名称' },
                        { k: 'time', l: '时间' },
                        { k: 'location', l: '地点' },
                        { k: 'content', l: '内容' },
                        { k: 'contractor', l: '承建商' },
                        { k: 'client', l: '业主' },
                        { k: 'amount', l: '金额' },
                        { k: 'currency', l: '货币' }
                    ];
                    fields.forEach(f => {
                        if (sub[f.k]) {
                            detailsHtml += `<div class="flex text-xs"><span class="w-20 text-gray-500 flex-shrink-0">${f.l}:</span><span class="text-gray-300">${sub[f.k]}</span></div>`;
                        }
                    });
                    if (sub.details) {
                        Object.entries(sub.details).forEach(([k, v]) => {
                            if (v && typeof v !== 'object') {
                                detailsHtml += `<div class="flex text-xs"><span class="w-20 text-gray-500 flex-shrink-0 truncate" title="${k}">${k}:</span><span class="text-gray-300 line-clamp-2" title="${v}">${v}</span></div>`;
                            }
                        });
                    }
                    modalEvents.innerHTML += `
                        <div class="bg-white/5 rounded p-3 border border-white/5">
                            <div class="font-bold text-xs text-gray-400 mb-2">#${idx + 1} ${sub.category || 'Event'}</div>
                            <div class="space-y-1">${detailsHtml || '<span class="text-gray-500 text-xs">无详细字段</span>'}</div>
                        </div>
                    `;
                });
            }

            modalTranslation.innerText = article.full_text_cn || '暂无全文翻译';
            modalSummaryCn.innerText = article.summary_cn || '暂无摘要';
            modalVlDesc.innerText = buildVlSupplement(article.summary_cn, article.vl_desc);

            modalLink.href = article.url || '#';

            if (article.screenshot_path) {
                modalImage.src = article.screenshot_path;
                modalImageContainer.classList.remove('hidden');
            } else {
                modalImageContainer.classList.add('hidden');
            }

            document.getElementById('detail-modal').classList.remove('hidden');
            requestAnimationFrame(() => {
                const bodyScroll = document.getElementById('modal-body-scroll');
                if (bodyScroll) bodyScroll.scrollTop = 0;
                const wrapper = document.getElementById('modal-wrapper');
                if (wrapper) wrapper.scrollTop = 0;
            });
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        function openImageZoom(src) {
            const img = document.getElementById('modal-image');
            const zoomModal = document.getElementById('image-zoom-modal');
            const zoomedImg = document.getElementById('zoomed-image');
            if (src) {
                zoomedImg.src = src;
            } else if (img && img.src) {
                zoomedImg.src = img.src;
            } else {
                return;
            }
            zoomModal.classList.remove('hidden');
        }

        function closeImageZoom() {
            document.getElementById('image-zoom-modal').classList.add('hidden');
        }

        document.getElementById('filter-start-date').addEventListener('change', scheduleSearch);
        document.getElementById('filter-end-date').addEventListener('change', scheduleSearch);
        document.getElementById('filter-keyword').addEventListener('input', scheduleSearch);
        document.getElementById('filter-category').addEventListener('change', scheduleSearch);
        document.getElementById('filter-source-type').addEventListener('change', scheduleSearch);
        document.getElementById('filter-source-name').addEventListener('change', scheduleSearch);

        document.getElementById('reset-btn').addEventListener('click', () => {
            setDefaultDates();
            document.getElementById('filter-keyword').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-source-type').value = '';
            document.getElementById('filter-source-name').value = '';
            state.page = 1;
            syncStateFromForm();
            fetchArticles();
        });

        document.getElementById('prev-page').addEventListener('click', () => {
            if (state.page > 1) {
                state.page -= 1;
                fetchArticles();
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            const maxPage = Math.ceil(state.total / state.pageSize) || 1;
            if (state.page < maxPage) {
                state.page += 1;
                fetchArticles();
            }
        });

        document.getElementById('history-list').addEventListener('click', (event) => {
            if (event.target.closest('.stop-prop')) return;
            const card = event.target.closest('[data-article-id]');
            if (card) {
                const articleId = card.getAttribute('data-article-id');
                if (articleId) openModalById(articleId);
            }
        });

        bindDateRangePicker('date-range', 'filter-start-date', 'filter-end-date');
        setDefaultDates();
        fetchSources().then(() => {
            syncStateFromForm();
            fetchArticles();
        });
    </script>
</body>
</html>
